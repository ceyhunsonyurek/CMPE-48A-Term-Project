{% extends 'base.html' %}
{% block title %}URL Shortener - Home{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}

{% block content %}
<div class="hero-section">
    <h1 class="hero-title">
        <i class="fas fa-magic"></i> SwiftShort
    </h1>
    <p class="hero-subtitle">Transform long URLs into short, shareable links with QR codes</p>
</div>

<div class="container">
    <div class="url-card">
        {% if 'user_id' in session %}
        <div class="welcome-message">
            Welcome back, <span class="username-highlight">{{ session['username'] }}</span>! ðŸ‘‹
        </div>
        {% endif %}

        {% if short_url %}
        <div class="short-url-display">
            <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; flex-wrap: wrap;">
                <div>
                    <i class="fas fa-link"></i> Your Short URL:
                    <br>
                    <a href="{{ short_url }}" target="_blank" id="shortUrlLink">{{ short_url }}</a>
                </div>
                <button class="btn-copy" onclick="copyToClipboard('{{ short_url }}', this)" title="Copy Short URL">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
        {% endif %}

        <form method="POST" action="{{ url_for('index') }}" class="url-form">
            <div class="form-group">
                <label for="url">
                    <i class="fas fa-globe"></i> Enter URL to Shorten
                </label>
                <input type="url" id="url" name="url" class="form-control" 
                    placeholder="https://example.com" required>
            </div>

            {% if image_path %}
            <div class="qr-code-container">
                <h5 style="color: var(--text-secondary); margin-bottom: 1rem;">
                    <i class="fas fa-qrcode"></i> Your QR Code
                </h5>
                <img src="{{ image_path }}" alt="QR Code" class="img-fluid" id="qrCodeImage">
                <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="downloadQRCode()">
                    <i class="fas fa-download"></i> Download QR Code
                </button>
            </div>
            {% else %}
            <div class="qr-code-container">
                <div style="width: 300px; height: 300px; margin: 0 auto; background: var(--bg-secondary); border: 2px dashed var(--border-color); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                    <i class="fas fa-qrcode" style="font-size: 4rem; color: var(--text-secondary); opacity: 0.5; margin-bottom: 1rem;"></i>
                    <p style="color: var(--text-secondary); text-align: center; padding: 0 1rem;">
                        QR code will appear here after shortening
                    </p>
                </div>
            </div>
            {% endif %}

            <button type="submit" class="btn btn-primary btn-block" style="margin-top: 1.5rem;">
                <i class="fas fa-compress"></i> Shorten URL
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function downloadQRCode() {
        const qrImage = document.getElementById('qrCodeImage');
        if (!qrImage || !qrImage.src) return;
        
        // Extract hashid from image src
        const imageSrc = qrImage.src;
        const hashid = imageSrc.split('/').pop().split('.')[0];
        
        // Use backend download endpoint - force download without dialog
        const downloadUrl = '/download-qr/' + hashid;
        
        // Method 1: Direct link click (works in most browsers)
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = hashid + '.png';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        
        // Clean up after a short delay
        setTimeout(function() {
            document.body.removeChild(link);
        }, 100);
    }
</script>
{% endblock %}
