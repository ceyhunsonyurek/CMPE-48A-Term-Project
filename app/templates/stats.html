{% extends 'base.html' %}
{% block title %}Statistics - SwiftShort{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/stats.css') }}">
{% endblock %}

{% block content %}
<div class="stats-header">
    <h1 class="stats-title">
        <i class="fas fa-chart-bar"></i> Statistics
    </h1>
    <p class="stats-subtitle">Track your shortened URLs and their performance</p>
</div>

<div class="container">
    <div class="stats-card">
        <h3 style="color: var(--text-primary); margin-bottom: 1.5rem;">
            <i class="fas fa-list"></i> Your URLs
        </h3>
        
        {% if urls %}
        {% if has_more %}
        <div class="alert alert-info" style="margin-bottom: 1rem;">
            <i class="fas fa-info-circle"></i> Showing last {{ urls|length }} URLs out of {{ total_urls }} total. Most recent URLs are displayed first.
        </div>
        {% endif %}
        <!-- Desktop Table View -->
        <div class="table-responsive-wrapper">
            <table class="urls-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Short URL</th>
                        <th>Original URL</th>
                        <th>Clicks</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for url in urls %}
                    {% set short_url_val = url['short_url'] %}
                    {% set original_url_val = url['original_url'] %}
                    {% set hashid_val = url['hashid'] %}
                    <tr>
                        <td class="url-id">{{ loop.index }}</td>
                        <td class="url-short">
                            <div class="url-cell-content">
                                <a href="{{ short_url_val }}" target="_blank" class="url-link url-link-short">
                                    {{ short_url_val }}
                                </a>
                                <button class="btn-copy" onclick="copyToClipboard('{{ short_url_val }}', this)" title="Copy URL">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </td>
                        <td class="url-original">
                            <div class="url-cell-content">
                                <a href="{{ original_url_val }}" target="_blank" class="url-link url-link-original" title="{{ original_url_val }}">
                                    {{ original_url_val }}
                                </a>
                                <button class="btn-copy" onclick="copyToClipboard('{{ original_url_val }}', this)" title="Copy URL">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </td>
                        <td class="url-clicks">
                            <span class="clicks-badge">
                                {{ url['clicks'] }}
                            </span>
                        </td>
                        <td class="url-created">{{ url['created'] }}</td>
                        <td class="url-actions">
                            <button class="btn-view-qr" onclick="viewQR('{{ hashid_val }}', '{{ short_url_val }}')">
                                <i class="fas fa-qrcode"></i> <span class="btn-text">View QR</span>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Mobile Card View -->
        <div class="url-cards-mobile">
            {% for url in urls %}
            {% set short_url_val = url['short_url'] %}
            {% set original_url_val = url['original_url'] %}
            {% set hashid_val = url['hashid'] %}
            <div class="url-card-item">
                <div class="url-card-header">
                    <span class="url-card-id">#{{ loop.index }}</span>
                    <span class="url-card-date">{{ url['created'] }}</span>
                </div>
                <div class="url-card-body">
                    <div class="url-card-field">
                        <label>Short URL:</label>
                        <div class="url-card-value">
                            <a href="{{ short_url_val }}" target="_blank" class="url-link">{{ short_url_val }}</a>
                            <button class="btn-copy btn-copy-small" onclick="copyToClipboard('{{ short_url_val }}', this)" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="url-card-field">
                        <label>Original URL:</label>
                        <div class="url-card-value">
                            <a href="{{ original_url_val }}" target="_blank" class="url-link" title="{{ original_url_val }}">{{ original_url_val }}</a>
                            <button class="btn-copy btn-copy-small" onclick="copyToClipboard('{{ original_url_val }}', this)" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="url-card-footer">
                        <div class="url-card-clicks">
                            <i class="fas fa-mouse-pointer"></i> {{ url['clicks'] }} clicks
                        </div>
                        <button class="btn-view-qr btn-view-qr-mobile" onclick="viewQR('{{ hashid_val }}', '{{ short_url_val }}')">
                            <i class="fas fa-qrcode"></i> View QR
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>No URLs created yet. Start shortening URLs to see statistics here.</p>
        </div>
        {% endif %}
    </div>

    {% if urls %}
    <div class="stats-summary">
        <div class="stat-item">
            <div class="stat-value">{{ total_urls }}</div>
            <div class="stat-label">Total URLs</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ total_clicks }}</div>
            <div class="stat-label">Total Clicks</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">
                {% if total_urls > 0 %}{{ total_clicks // total_urls }}{% else %}0{% endif %}
            </div>
            <div class="stat-label">Avg Clicks/URL</div>
        </div>
    </div>
    {% endif %}
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content qr-modal-content">
            <div class="modal-header qr-modal-header">
                <h5 class="modal-title" id="qrModalLabel">
                    <i class="fas fa-qrcode"></i> QR Code
                </h5>
                <button type="button" class="close qr-modal-close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body qr-modal-body">
                <div class="qr-image-wrapper">
                    <img id="qrImage" src="" alt="QR Code" class="qr-modal-image">
                </div>
                <div class="qr-modal-actions">
                    <button class="btn btn-primary btn-download-qr" onclick="downloadQR()">
                        <i class="fas fa-download"></i> Download QR Code
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentHashid = '';
    let currentShortUrl = '';

    function viewQR(hashid, shortUrl) {
        currentHashid = hashid;
        currentShortUrl = shortUrl;
        const qrImage = document.getElementById('qrImage');
        qrImage.src = '{{ gcs_base_url }}/' + hashid + '.png';
        $('#qrModal').modal('show');
    }

    function downloadQR() {
        if (!currentHashid) return;
        
        // Use backend download endpoint - force download without dialog
        const downloadUrl = '/download-qr/' + currentHashid;
        
        // Direct link click (works in most browsers)
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = currentHashid + '.png';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        
        // Clean up after a short delay
        setTimeout(function() {
            document.body.removeChild(link);
        }, 100);
    }
</script>
{% endblock %}
